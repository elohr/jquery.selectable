/*
 * jquery.dateRangePicker
 * https://elohr.me/
 *
 * Copyright (c) 2014 elohr
 * Licensed under the MIT license.
 */
function Selectable(e,t){"use strict";var l={lastSearchValue:"",selectedOptions:[],selectedOptionsContainer:window.jQuery("<ul/>"),liForSelectButton:window.jQuery("<li/>",{"class":"selectable-button-container"}),selectButton:window.jQuery("<button/>",{type:"button",text:"Select"}),overlay:window.jQuery("<div/>",{"class":"plugin-overlay selectable-overlay"}),popup:window.jQuery("<div/>",{"class":"selectable-popup"}),defaultOptions:$(e).children(),closeButton:window.jQuery("<img/>",{"class":"selectable-close-icon",src:"css/close.png"}),searchForm:window.jQuery("<form/>",{action:t.formAction,method:t.formMethod}),searchLabel:window.jQuery("<label>Search</label>"),searchBox:window.jQuery("<input/>",{"class":"selectable-search",type:"text",name:"search"}),popupTitleContainer:window.jQuery("<div/>",{"class":"selectable-popup-title-container"}),popupTitle:window.jQuery("<div/>",{"class":"selectable-popup-title"}),resultsContainer:window.jQuery("<div/>",{"class":"selectable-results-container"}),placeholder:window.jQuery("<li/>",{"class":"selectable-placeholder"}),okButton:window.jQuery("<button/>",{"class":"button-selectable highlight-button-selectable"}),newButton:window.jQuery("<button/>",{"class":"button-selectable normal-button-selectable"}),init:function(){return t.remoteSearch&&!t.formAction?void console.log("Error init Selectable: remoteSearch is true but no formAction was specified."):(l.defaultOptions.addClass("selectable-default-option selectable-result-item").detach(),l.closeButton.click(l.close),l.overlay.click(l.close),l.okButton.click(l.close),l.searchLabel.click(l.focusSearchBox),l.searchBox.keyup(l.searchKeyUp),l.selectButton.focus(l.open),l.resultsContainer.on("click",".selectable-result-item",l.resultClicked),l.selectedOptionsContainer.on("click",".selectable-li",l.liOptionClicked),$(e).on("destroyed",l.kill),t.showNewButton&&l.newButton.click(t.newButtonClicked),l.searchForm.append(l.searchLabel,[l.searchBox]),t.popupTitle||(t.popupTitle=$(e).attr("data-title")),t.popupTitle&&(l.popupTitle=l.popupTitle.text(t.popupTitle),l.popupTitleContainer.append(l.popupTitle),l.popup.append(l.popupTitleContainer)),t.placeholder||(t.placeholder=$(e).attr("data-placeholder")),t.placeholder&&(l.placeholder.text(t.placeholder),l.selectedOptionsContainer.prepend(l.placeholder)),t.showNewButton?l.newButton.text("New "+t.popupTitle).css({position:"absolute",left:"12px",bottom:"12px"}):l.newButton.css("display","none"),l.okButton.text("OK").css({position:"absolute",right:"12px",bottom:"0px"}),l.popup.append(l.closeButton,[l.searchForm,l.resultsContainer,l.newButton,l.okButton]),l.liForSelectButton.append(l.selectButton),l.selectedOptionsContainer.append(l.liForSelectButton),$(e).prepend(l.selectedOptionsContainer),$(document.body).append(l.popup,[l.overlay]),void 0===t.fieldName&&(t.fieldName=$(e).attr("data-title").replace(new RegExp(" ","g"),"_")),void t.initialized())},open:function(){t.opening(),l.addSelectedItemsAndDefaultOptions(),l.previousOverlay=$(".plugin-overlay:visible"),l.previousOverlay.hide(),l.overlay.show(),l.popup.css({left:($(window).width()-l.popup.outerWidth())/2,top:$(e).offset().top+24}).addClass("plugin-fade"),t.opened(e),l.searchBox.val(""),l.focusSearchBox()},close:function(){var o=[],n=$("<input>").attr({type:"hidden",name:t.fieldName,"class":"selectable-hidden-"+t.fieldName});t.closing(),t.fieldId&&n.attr("id",t.fieldId),l.selectedOptions=[],l.selectedOptionsContainer.children(".selectable-li").remove(),l.resultsContainer.children(".selectable-selected").each(function(){var e=$(this);e.detach(),l.selectedOptions.push(e),o.push(e.attr("data-value")),l.selectedOptionsContainer.prepend('<li data-value="'+e.attr("data-value")+'" class="selectable-li">'+e.text()+"</li>")}),$(e).siblings(".selectable-hidden-"+t.fieldName).remove(),n.val(JSON.stringify(o)),$(e).after(n),t.placeholder&&(o.length>0?l.placeholder.hide():l.placeholder.show()),l.overlay.hide(),l.previousOverlay.show(),l.popup.removeClass("plugin-fade"),l.defaultOptions.detach(),l.resultsContainer.children().remove(),t.closed(l.selectedOptions)},focusSearchBox:function(){l.searchBox.focus()},searchKeyUp:function(){var e=l.searchBox.val().trim();e.length<t.minLengthForSearch?(l.resultsContainer.children().not(".selectable-selected").not(".selectable-default-option").remove(),l.addSelectedItemsAndDefaultOptions(),t.minSearchLengthNotReached()):l.lastSearchValue!==e&&l.search(e)},search:function(e){var o;l.lastSearchValue=e,clearTimeout($.data(l.searchBox[0],"timer")),o=setTimeout(function(){l.submitSearch(e)},t.searchDelay),l.searchBox.data("timer",o)},submitSearch:function(e){var o=!1;t.remoteSearch&&$.ajax({url:t.formAction,type:t.formMethod,data:l.searchForm.serializeArray()}).done(function(e){if(l.resultsContainer.children().not(".selectable-selected").remove(),e.no_results)return void t.noResults();for(var n=e.results.length-1;n>=0;n--)l.resultsContainer.children().each(function(){return $(this).text()===e.results[n]?(o=!0,!1):void 0}),o||l.resultsContainer.append(e.results[n].value?'<span class="selectable-result-item" data-value="'+e.results[n].value+'">'+e.results[n].text+"</span>":'<span class="selectable-result-item" data-value="'+e.results[n]+'">'+e.results[n]+"</span>");t.optionsLoaded()}).fail(function(e){t.searchFailed(e)}),t.searching(e),l.resultsContainer.children().not(".selectable-selected").each(function(){var t=$(this);l.hideItemIfNotMatchesSearch(t,e)})},hideItemIfNotMatchesSearch:function(e,t){e.text().toLowerCase().indexOf(t.toLowerCase())<0&&(e.hasClass("selectable-default-option")?e.detach():e.remove())},resultClicked:function(){var e=$(this);e.hasClass("selectable-selected")?(l.removeFromSelection(e.attr("data-value")),l.hideItemIfNotMatchesSearch(e,l.searchBox.val().trim()),t.selectionRemoved(),l.focusSearchBox()):(t.allowMultipleSelect||e.siblings(".selectable-selected").each(function(){l.removeFromSelection($(this).attr("data-value"))}),e.addClass("selectable-selected"),t.selectionAdded(),t.allowMultipleSelect?l.focusSearchBox():l.close())},liOptionClicked:function(){var o=$(e).siblings(".selectable-hidden-"+t.fieldName),n=JSON.parse(o.val());n.splice(n.indexOf($(this).attr("data-value")),1),n.length>0?o.val(JSON.stringify(n)):(o.remove(),t.placeholder&&l.placeholder.show()),l.removeFromSelection($(this).attr("data-value")),$(this).remove(),t.activeSelectionRemoved()},removeFromSelection:function(e){var t=!1;$(l.selectedOptions).each(function(o){return $(this).attr("data-value")===e?($(this).removeClass("selectable-selected"),l.selectedOptions.splice(o,1),t=!0,!1):void 0}),t||l.resultsContainer.children(".selectable-result-item").each(function(){return $(this).attr("data-value")===e?($(this).removeClass("selectable-selected"),!1):void 0})},addSelectedItemsAndDefaultOptions:function(){l.resultsContainer.append(l.selectedOptions),0===l.selectedOptions.length?l.resultsContainer.append(l.defaultOptions):l.defaultOptions.each(function(){var e=!1,t=$(this).attr("data-value");$(l.selectedOptions).each(function(){return t===$(this).attr("data-value")?(e=!0,!1):void 0}),e||l.resultsContainer.append($(this))})},kill:function(){$(e).remove(),l.overlay.remove(),l.popup.remove()}};t=t||{},t.popupTitle=t.popupTitle,t.formAction=t.formAction,t.formMethod=t.formMethod||"POST",t.minLengthForSearch=t.minLengthForSearch||2,t.allowMultipleSelect=t.allowMultipleSelect||!1,t.fieldName=t.fieldName,t.fieldId=t.fieldId,t.placeholder=t.placeholder,t.remoteSearch=t.remoteSearch||!1,t.showNewButton=t.showNewButton||!1,t.searchDelay=t.searchDelay||350,t.initialized=t.initialized||function(){},t.selectionAdded=t.selectionAdded||function(){},t.selectionRemoved=t.selectionRemoved||function(){},t.activeSelectionRemoved=t.activeSelectionRemoved||function(){},t.opening=t.opening||function(){},t.opened=t.opened||function(){},t.closing=t.closing||function(){},t.closed=t.closed||function(){},t.searching=t.searching||function(){},t.searchFailed=t.searchFailed||function(){},t.optionsLoaded=t.optionsLoaded||function(){},t.minSearchLengthNotReached=t.minSearchLengthNotReached||function(){},t.newButtonClicked=t.newButtonClicked||function(){},t.noResults=t.noResults||function(){};var o={handleEvent:function(e){switch(e.type){case"click":this.click(e)}},click:function(){l.open()}};return l.init(),l.selectButton[0].addEventListener("click",o,!1),{kill:l.kill,val:function(){return $(e).siblings(".selectable-hidden-"+t.fieldName).val()},selectionCount:function(){return l.selectedOptions.length},open:l.open,close:l.close,removeSelection:function(){l.selectedOptionsContainer.children(".selectable-li").each(function(){l.removeFromSelection($(this).attr("data-value")),$(this).remove()}),$(e).siblings(".selectable-hidden-"+t.fieldName).remove()},search:function(e){e.trim().length>0&&(l.searchBox.val(e),l.search(e))},addHiddenFieldToSearch:function(e,t){var o;0===l.searchForm.children('[name="'+e+'"]').length&&(o=$("<input>").attr({type:"hidden",name:e}),o.val(t),l.searchForm.append(o))},getNewButtonDOMElement:function(){return l.newButton}}}window.jQuery&&!function(e){var t="Selectable",l={init:function(l){return this.each(function(){var o=e(this),n=o.data(t);if(!n){var a={};l&&e.extend(!0,a,l),o.data(t,new Selectable(e(this)[0],a))}})}};e.fn[t]=function(o){return l[o]?l[o].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof o&&o?void e.error("Method "+o+" does not exist in jQuery."+t):l.init.apply(this,arguments)}}(window.jQuery);