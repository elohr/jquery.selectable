/*
 * jquery.dateRangePicker
 * https://elohr.me/
 *
 * Copyright (c) 2014 elohr
 * Licensed under the MIT license.
 */
function Selectable(e,t){"use strict";var o={lastSearchValue:"",selectedOptions:[],selectedOptionsContainer:window.jQuery("<ul/>"),liForSelectButton:window.jQuery("<li/>",{"class":"selectable-button-container"}),selectButton:window.jQuery("<button/>",{type:"button",text:"Select"}),overlay:window.jQuery("<div/>",{"class":"plugin-overlay selectable-overlay"}),popup:window.jQuery("<div/>",{"class":"selectable-popup"}),defaultOptions:$(e).children(),closeButton:window.jQuery("<img/>",{"class":"selectable-close-icon",src:"css/close.png"}),searchForm:window.jQuery("<form/>",{action:t.formAction,method:t.formMethod}),searchLabel:window.jQuery("<label>Search</label>"),searchBox:window.jQuery("<input/>",{"class":"selectable-search",type:"text",name:"search"}),popupTitleContainer:window.jQuery("<div/>",{"class":"selectable-popup-title-container"}),popupTitle:window.jQuery("<div/>",{"class":"selectable-popup-title"}),resultsContainer:window.jQuery("<div/>",{"class":"selectable-results-container"}),placeholder:window.jQuery("<li/>",{"class":"selectable-placeholder"}),okButton:window.jQuery("<button/>",{"class":"button-selectable highlight-button-selectable"}),newButton:window.jQuery("<button/>",{"class":"button-selectable normal-button-selectable"}),init:function(){return t.remoteSearch&&!t.formAction?void console.log("Error init Selectable: remoteSearch is true but no formAction was specified."):(o.defaultOptions.addClass("selectable-default-option selectable-result-item").detach(),o.closeButton.click(o.close),o.overlay.click(o.close),o.okButton.click(o.close),o.searchLabel.click(o.focusSearchBox),o.searchBox.keyup(o.searchKeyUp),o.selectButton.focus(o.open),o.resultsContainer.on("click",".selectable-result-item",o.resultClicked),o.selectedOptionsContainer.on("click",".selectable-li",o.liOptionClicked),$(e).on("destroyed",o.kill),t.showNewButton&&o.newButton.click(t.newButtonClicked),o.searchForm.append(o.searchLabel,[o.searchBox]),t.popupTitle||(t.popupTitle=$(e).attr("data-title")),t.popupTitle&&(o.popupTitle=o.popupTitle.text(t.popupTitle),o.popupTitleContainer.append(o.popupTitle),o.popup.append(o.popupTitleContainer)),t.placeholder||(t.placeholder=$(e).attr("data-placeholder")),t.placeholder&&(o.placeholder.text(t.placeholder),o.selectedOptionsContainer.prepend(o.placeholder)),t.showNewButton?o.newButton.text("New "+t.popupTitle).css({position:"absolute",left:"12px",bottom:"12px"}):o.newButton.css("display","none"),o.okButton.text("OK").css({position:"absolute",right:"12px",bottom:"0px"}),o.popup.append(o.closeButton,[o.searchForm,o.resultsContainer,o.newButton,o.okButton]),o.liForSelectButton.append(o.selectButton),o.selectedOptionsContainer.append(o.liForSelectButton),$(e).prepend(o.selectedOptionsContainer),$(document.body).append(o.popup,[o.overlay]),void 0===t.fieldName&&(t.fieldName=$(e).attr("data-title").replace(new RegExp(" ","g"),"_")),void t.initialized())},open:function(){t.opening(),o.addSelectedItemsAndDefaultOptions(),o.previousOverlay=$(".plugin-overlay:visible"),o.previousOverlay.hide(),o.overlay.show(),o.popup.css({left:($(window).width()-o.popup.outerWidth())/2,top:$(e).offset().top+24}).addClass("plugin-fade"),o.popup.offset().top+o.popup.outerHeight(!0)>$(window).height()&&o.popup.css({top:$(e).offset().top+24-o.popup.outerHeight(!0)}),t.opened(e),o.searchBox.val(""),o.focusSearchBox()},close:function(){var l=[],n=$("<input>").attr({type:"hidden",name:t.fieldName,"class":"selectable-hidden-"+t.fieldName});t.closing(),t.fieldId&&n.attr("id",t.fieldId),o.selectedOptions=[],o.selectedOptionsContainer.children(".selectable-li").remove(),o.resultsContainer.children(".selectable-selected").each(function(){var e=$(this);e.detach(),o.selectedOptions.push(e),l.push(e.attr("data-value")),o.selectedOptionsContainer.prepend('<li data-value="'+e.attr("data-value")+'" class="selectable-li">'+e.text()+"</li>")}),$(e).siblings(".selectable-hidden-"+t.fieldName).remove(),n.val(JSON.stringify(l)),$(e).after(n),t.placeholder&&(l.length>0?o.placeholder.hide():o.placeholder.show()),o.overlay.hide(),o.previousOverlay.show(),o.popup.removeClass("plugin-fade"),o.defaultOptions.detach(),o.resultsContainer.children().remove(),t.closed(o.selectedOptions)},focusSearchBox:function(){o.searchBox.focus()},searchKeyUp:function(){var e=o.searchBox.val().trim();e.length<t.minLengthForSearch?(o.resultsContainer.children().not(".selectable-selected").not(".selectable-default-option").remove(),o.addSelectedItemsAndDefaultOptions(),t.minSearchLengthNotReached()):o.lastSearchValue!==e&&o.search(e)},search:function(e){var l;o.lastSearchValue=e,clearTimeout($.data(o.searchBox[0],"timer")),l=setTimeout(function(){o.submitSearch(e)},t.searchDelay),o.searchBox.data("timer",l)},submitSearch:function(e){var l=!1;t.remoteSearch&&$.ajax({url:t.formAction,type:t.formMethod,data:o.searchForm.serializeArray()}).done(function(e){if(o.resultsContainer.children().not(".selectable-selected").remove(),e.no_results)return void t.noResults();for(var n=e.results.length-1;n>=0;n--)o.resultsContainer.children().each(function(){return $(this).text()===e.results[n]?(l=!0,!1):void 0}),l||o.resultsContainer.append(e.results[n].value?'<span class="selectable-result-item" data-value="'+e.results[n].value+'">'+e.results[n].text+"</span>":'<span class="selectable-result-item" data-value="'+e.results[n]+'">'+e.results[n]+"</span>");t.optionsLoaded()}).fail(function(e){t.searchFailed(e)}),t.searching(e),o.resultsContainer.children().not(".selectable-selected").each(function(){var t=$(this);o.hideItemIfNotMatchesSearch(t,e)})},hideItemIfNotMatchesSearch:function(e,t){e.text().toLowerCase().indexOf(t.toLowerCase())<0&&(e.hasClass("selectable-default-option")?e.detach():e.remove())},resultClicked:function(){var e=$(this);e.hasClass("selectable-selected")?(o.removeFromSelection(e.attr("data-value")),o.hideItemIfNotMatchesSearch(e,o.searchBox.val().trim()),t.selectionRemoved(),o.focusSearchBox()):(t.allowMultipleSelect||e.siblings(".selectable-selected").each(function(){o.removeFromSelection($(this).attr("data-value"))}),e.addClass("selectable-selected"),t.selectionAdded(),t.allowMultipleSelect?o.focusSearchBox():o.close())},liOptionClicked:function(){var l=$(e).siblings(".selectable-hidden-"+t.fieldName),n=JSON.parse(l.val());n.splice(n.indexOf($(this).attr("data-value")),1),n.length>0?l.val(JSON.stringify(n)):(l.remove(),t.placeholder&&o.placeholder.show()),o.removeFromSelection($(this).attr("data-value")),$(this).remove(),t.activeSelectionRemoved()},removeFromSelection:function(e){var t=!1;$(o.selectedOptions).each(function(l){return $(this).attr("data-value")===e?($(this).removeClass("selectable-selected"),o.selectedOptions.splice(l,1),t=!0,!1):void 0}),t||o.resultsContainer.children(".selectable-result-item").each(function(){return $(this).attr("data-value")===e?($(this).removeClass("selectable-selected"),!1):void 0})},addSelectedItemsAndDefaultOptions:function(){o.resultsContainer.append(o.selectedOptions),0===o.selectedOptions.length?o.resultsContainer.append(o.defaultOptions):o.defaultOptions.each(function(){var e=!1,t=$(this).attr("data-value");$(o.selectedOptions).each(function(){return t===$(this).attr("data-value")?(e=!0,!1):void 0}),e||o.resultsContainer.append($(this))})},kill:function(){$(e).remove(),o.overlay.remove(),o.popup.remove()}};t=t||{},t.popupTitle=t.popupTitle,t.formAction=t.formAction,t.formMethod=t.formMethod||"POST",t.minLengthForSearch=t.minLengthForSearch||2,t.allowMultipleSelect=t.allowMultipleSelect||!1,t.fieldName=t.fieldName,t.fieldId=t.fieldId,t.placeholder=t.placeholder,t.remoteSearch=t.remoteSearch||!1,t.showNewButton=t.showNewButton||!1,t.searchDelay=t.searchDelay||350,t.initialized=t.initialized||function(){},t.selectionAdded=t.selectionAdded||function(){},t.selectionRemoved=t.selectionRemoved||function(){},t.activeSelectionRemoved=t.activeSelectionRemoved||function(){},t.opening=t.opening||function(){},t.opened=t.opened||function(){},t.closing=t.closing||function(){},t.closed=t.closed||function(){},t.searching=t.searching||function(){},t.searchFailed=t.searchFailed||function(){},t.optionsLoaded=t.optionsLoaded||function(){},t.minSearchLengthNotReached=t.minSearchLengthNotReached||function(){},t.newButtonClicked=t.newButtonClicked||function(){},t.noResults=t.noResults||function(){};var l={handleEvent:function(e){switch(e.type){case"click":this.click(e)}},click:function(){o.open()}};return o.init(),o.selectButton[0].addEventListener("click",l,!1),{kill:o.kill,val:function(){return $(e).siblings(".selectable-hidden-"+t.fieldName).val()},selectionCount:function(){return o.selectedOptions.length},open:o.open,close:o.close,removeSelection:function(){o.selectedOptionsContainer.children(".selectable-li").each(function(){o.removeFromSelection($(this).attr("data-value")),$(this).remove()}),$(e).siblings(".selectable-hidden-"+t.fieldName).remove()},search:function(e){e.trim().length>0&&(o.searchBox.val(e),o.search(e))},addHiddenFieldToSearch:function(e,t){var l;0===o.searchForm.children('[name="'+e+'"]').length&&(l=$("<input>").attr({type:"hidden",name:e}),l.val(t),o.searchForm.append(l))},getNewButtonDOMElement:function(){return o.newButton}}}window.jQuery&&!function(e){var t="Selectable",o={init:function(o){return this.each(function(){var l=e(this),n=l.data(t);if(!n){var a={};o&&e.extend(!0,a,o),l.data(t,new Selectable(e(this)[0],a))}})}};e.fn[t]=function(l){return o[l]?o[l].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof l&&l?void e.error("Method "+l+" does not exist in jQuery."+t):o.init.apply(this,arguments)}}(window.jQuery);